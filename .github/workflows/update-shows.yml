name: Update Whatnot Shows

on:
  schedule:
    - cron: '30 */6 * * *'  # Every 6 hours
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install e2b-code-interpreter

      - name: Fetch Whatnot shows
        env:
          E2B_API_KEY: ${{ secrets.E2B_API_KEY }}
        run: |
          python3 << 'PYEOF'
          import os, json, re
          from e2b_code_interpreter import Sandbox

          sbx = Sandbox.create(timeout=120)

          r = sbx.run_code("""
          import requests, json, re

          s = requests.Session()
          s.headers.update({
              'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 17_0 like Mac OS X) AppleWebKit/605.1.15',
              'Accept': 'text/html',
          })
          resp = s.get("https://www.whatnot.com/user/sakima", timeout=30)
          text = resp.text

          # Parse Apollo SSR data from script tags
          scripts = re.findall(r'<script[^>]*>(.*?)</script>', text, re.DOTALL)
          apollo_data = []
          for scr in scripts:
              if 'ApolloSSRDataTransport' in scr and '.push(' in scr:
                  idx = scr.index('.push(') + 6
                  ridx = scr.rindex(')')
                  try:
                      blob = json.loads(scr[idx:ridx])
                      apollo_data.append(blob)
                  except:
                      pass

          # Recursively find livestream-like objects in Apollo cache
          def find_livestreams(obj, depth=0):
              if depth > 30:
                  return []
              results = []
              if isinstance(obj, dict):
                  tn = str(obj.get('__typename', '')).lower()
                  has_title = 'title' in obj
                  is_livestream = 'livestream' in tn or 'stream' in tn
                  is_node = is_livestream and has_title and 'edges' not in obj and 'totalCount' not in obj
                  if is_node:
                      results.append(obj)
                  for v in obj.values():
                      if isinstance(v, (dict, list)):
                          results.extend(find_livestreams(v, depth + 1))
              elif isinstance(obj, list):
                  for v in obj:
                      if isinstance(v, (dict, list)):
                          results.extend(find_livestreams(v, depth + 1))
              return results

          all_shows = []
          sample_keys = None
          for blob in apollo_data:
              found = find_livestreams(blob)
              for item in found:
                  if sample_keys is None:
                      sample_keys = list(item.keys())
                  all_shows.append(item)

          # Debug: dump raw field values from first show
          first_raw = None
          if all_shows:
              first = all_shows[0]
              first_raw = {}
              for k in ('startTime', 'thumbnail', 'totalWatchlistUsers', 'tags', 'title', 'id'):
                  v = first.get(k)
                  first_raw[k] = repr(v)[:200] if v is not None else None

          # Extract show data using known Whatnot field names
          seen = set()
          unique_shows = []
          for item in all_shows:
              title = item.get('title', '')
              date_val = item.get('startTime')
              # Handle thumbnail - could be dict, __ref, or string
              thumb_obj = item.get('thumbnail')
              thumb = None
              if isinstance(thumb_obj, dict):
                  if '__ref' in thumb_obj:
                      # Apollo cache reference - try to resolve from blob
                      ref = thumb_obj['__ref']
                      for blob in apollo_data:
                          rehydrate = blob.get('rehydrate', {})
                          for cache_val in rehydrate.values():
                              if isinstance(cache_val, dict):
                                  data = cache_val.get('data', {})
                                  # Deep search for the ref
                                  def resolve_ref(obj, ref_id, d=0):
                                      if d > 10: return None
                                      if isinstance(obj, dict):
                                          if obj.get('id') == ref_id or obj.get('__ref') == ref_id:
                                              return obj.get('url', obj.get('src', ''))
                                          for v in obj.values():
                                              r = resolve_ref(v, ref_id, d+1)
                                              if r: return r
                                      elif isinstance(obj, list):
                                          for v in obj:
                                              r = resolve_ref(v, ref_id, d+1)
                                              if r: return r
                                      return None
                                  thumb = resolve_ref(data, ref)
                                  if thumb: break
                  else:
                      thumb = thumb_obj.get('url', thumb_obj.get('src', thumb_obj.get('uri', '')))
              elif isinstance(thumb_obj, str):
                  thumb = thumb_obj

              rsvp = item.get('totalWatchlistUsers')
              if isinstance(rsvp, (int, float)):
                  rsvp = int(rsvp)
              else:
                  rsvp = None

              # Tags - extract 'label' field from LivestreamTagNode objects
              tags = []
              for ck in ('tags', 'livestreamCategories', 'livestreamLabels'):
                  val = item.get(ck)
                  if isinstance(val, list):
                      for t in val:
                          if isinstance(t, dict):
                              label = t.get('label', t.get('name', t.get('title', '')))
                              if label and label not in tags:
                                  tags.append(label)
                          elif isinstance(t, str) and t not in tags:
                              tags.append(t)

              key = f"{title}|{date_val}"
              if key not in seen:
                  seen.add(key)
                  unique_shows.append({
                      "title": title,
                      "date": date_val,
                      "image": thumb,
                      "rsvp": rsvp,
                      "tags": tags,
                  })

          print(json.dumps({
              "shows": unique_shows,
              "debug": {
                  "apollo_blobs": len(apollo_data),
                  "raw_shows": len(all_shows),
                  "unique_shows": len(unique_shows),
                  "sample_keys": sample_keys,
                  "first_raw": first_raw,
                  "page_length": len(text),
              }
          }))
          """, timeout=60)

          output = ""
          for log in r.logs.stdout:
              output += str(log)
          for res in r.results:
              output += res.text if hasattr(res, 'text') else str(res)

          sbx.kill()

          # Parse scraped data
          try:
              data = json.loads(output.strip())
              scraped = data.get("shows", [])
              debug = data.get("debug", {})
              print(f"Debug: {json.dumps(debug)}")
          except:
              scraped = []
              print(f"Failed to parse output: {output[:1000]}")

          if scraped:
              shows = []
              for s in scraped:
                  shows.append({
                      "title": s.get("title", ""),
                      "tags": s.get("tags", []),
                      "date": s.get("date"),
                      "rsvp": s.get("rsvp"),
                      "image": s.get("image"),
                  })

              # Sort by date
              shows.sort(key=lambda s: s.get("date") or "")

              with open("data/shows.json", "w") as f:
                  json.dump(shows, f, indent=2)
              print(f"Wrote {len(shows)} shows from scraped data")
          else:
              print("No shows scraped - keeping existing data")
          PYEOF

      - name: Commit if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/shows.json
          if git diff --staged --quiet; then
            echo "No changes to shows"
          else
            git commit -m "Auto-update Whatnot show thumbnails [skip ci]"
            git push
          fi
